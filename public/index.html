<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>Departures</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            -webkit-align-items: center;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #333;
        }

        .title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .clock {
            font-size: 2rem;
            font-weight: 300;
        }

        .status {
            font-size: 0.75rem;
            color: #666;
            margin-top: 4px;
        }

        .status.online { color: #4ade80; }
        .status.error { color: #f87171; }

        .stops-grid {
            display: -webkit-flex;
            display: flex;
            -webkit-flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 24px;
        }

        .stop-section {
            background: #0f0f1a;
            border-radius: 16px;
            padding: 16px;
            -webkit-flex: 1 1 350px;
            flex: 1 1 350px;
            min-width: 300px;
        }

        .stop-header {
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: flex-start;
            justify-content: flex-start;
            -webkit-align-items: center;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #333;
            gap: 8px;
        }

        .stop-header .stop-name {
            -webkit-flex: 1;
            flex: 1;
        }

        .stop-header .drag-handle {
            margin-right: 0;
        }

        .stop-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #88a4ff;
        }

        .stop-status {
            font-size: 0.7rem;
            color: #666;
        }

        .departures {
            display: -webkit-flex;
            display: flex;
            -webkit-flex-direction: column;
            flex-direction: column;
        }

        .departure {
            display: -webkit-flex;
            display: flex;
            -webkit-align-items: center;
            align-items: center;
            padding: 12px;
            background: #16213e;
            border-radius: 10px;
            border-left: 4px solid #666;
            margin-bottom: 10px;
        }

        .departure.line-u { border-left-color: #0063af; }
        .departure.line-s { border-left-color: #008d4f; }
        .departure.line-str { border-left-color: #be1622; }
        .departure.line-bus { border-left-color: #7b2d8e; }
        .departure.line-re { border-left-color: #ec1c24; }

        .line {
            font-size: 1.2rem;
            font-weight: 700;
            text-align: center;
            padding: 6px;
            border-radius: 6px;
            background: #666;
            color: #fff;
            min-width: 50px;
            margin-right: 12px;
        }

        .departure.line-u .line { background: #0063af; }
        .departure.line-s .line { background: #008d4f; }
        .departure.line-str .line { background: #be1622; }
        .departure.line-bus .line { background: #7b2d8e; }
        .departure.line-re .line { background: #ec1c24; }

        .dest-info {
            -webkit-flex: 1;
            flex: 1;
            min-width: 0;
        }

        .destination {
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .platform {
            font-size: 0.75rem;
            color: #888;
            margin-top: 2px;
        }

        .time-info {
            text-align: right;
            margin-left: 12px;
        }

        .minutes {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .minutes.soon { color: #fbbf24; }
        .minutes.now { color: #4ade80; }

        .scheduled {
            font-size: 0.75rem;
            color: #888;
        }

        .delay {
            color: #f87171;
            font-size: 0.7rem;
        }

        .loading, .error-msg {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }

        .error-msg { color: #f87171; }

        .settings-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #16213e;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: -webkit-flex;
            display: flex;
            -webkit-align-items: center;
            align-items: center;
            -webkit-justify-content: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            color: #888;
            font-size: 1.5rem;
            z-index: 100;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            -webkit-align-items: flex-start;
            align-items: flex-start;
            -webkit-justify-content: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
            z-index: 200;
        }

        .modal.open { 
            display: -webkit-flex;
            display: flex; 
        }

        .modal-content {
            background: #16213e;
            padding: 24px;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            margin: 40px 0;
        }

        .modal h2 {
            margin-bottom: 20px;
        }

        .modal h3 {
            margin: 20px 0 12px;
            font-size: 1rem;
            color: #88a4ff;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #888;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #1a1a2e;
            color: #fff;
            font-size: 16px; /* Prevents zoom on iOS */
        }

        .stop-config {
            background: #1a1a2e;
            -webkit-border-radius: 12px;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
            display: -webkit-flex;
            display: flex;
            -webkit-flex-wrap: wrap;
            flex-wrap: wrap;
            -webkit-align-items: flex-start;
            align-items: flex-start;
        }

        .stop-config .drag-handle {
            position: absolute;
            left: 8px;
            top: 16px;
            z-index: 5;
        }

        .stop-config .remove-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 5;
        }

        .stop-config > .form-group,
        .stop-config > .platform-loading,
        .stop-config > label,
        .stop-config > .time-range-row,
        .stop-config > .stop-info {
            margin-left: 40px;
            width: calc(100% - 40px);
        }

        .stop-config .remove-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #f87171;
            border: none;
            color: #fff;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            line-height: 24px;
        }

        .search-results {
            max-height: 200px;
            overflow-y: auto;
            background: #0f0f1a;
            border-radius: 8px;
            margin-top: 8px;
        }

        .search-result {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            -webkit-tap-highlight-color: rgba(255,255,255,0.1);
        }

        .search-result:hover,
        .search-result:active {
            background: #1a1a2e;
        }

        .search-result small {
            color: #666;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 8px;
        }

        .btn-primary {
            background: #3b82f6;
            color: #fff;
        }

        .btn-secondary {
            background: #333;
            color: #fff;
            margin-right: 8px;
        }

        .btn-add {
            background: #22c55e;
            color: #fff;
            width: 100%;
            margin-bottom: 16px;
        }

        .btn-row {
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: flex-end;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            width: 100%;
        }

        .empty-state p {
            margin-bottom: 16px;
        }

        .stop-info {
            font-size: 0.8rem;
            color: #666;
        }

        .platform-dropdown {
            position: relative;
        }

        .platform-selected {
            padding: 12px;
            background: #0f0f1a;
            border-radius: 8px;
            cursor: pointer;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-pack: justify;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-tap-highlight-color: rgba(255,255,255,0.1);
        }

        .platform-selected:after {
            content: "▼";
            font-size: 0.7rem;
            color: #666;
        }

        .platform-dropdown.open .platform-selected:after {
            content: "▲";
        }

        .platform-options {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: #0f0f1a;
            border-radius: 8px;
            margin-top: 4px;
            z-index: 10;
        }

        .platform-dropdown.open .platform-options {
            display: block;
        }

        .platform-option {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            -webkit-tap-highlight-color: rgba(255,255,255,0.1);
        }

        .platform-option:last-child {
            border-bottom: none;
        }

        .platform-option:hover,
        .platform-option:active {
            background: #1a1a2e;
        }

        .platform-option.selected {
            background: #16213e;
            color: #88a4ff;
        }

        .platform-option:before {
            content: "☐";
            margin-right: 8px;
            font-size: 1rem;
        }

        .platform-option.selected:before {
            content: "☑";
            color: #4ade80;
        }

        .platform-loading {
            padding: 12px;
            color: #888;
            font-size: 0.9rem;
        }

        .platform-badge {
            font-size: 0.75rem;
            color: #fbbf24;
            margin-left: 8px;
        }

        .time-badge {
            font-size: 0.75rem;
            color: #60a5fa;
            margin-left: 8px;
        }

        .time-range-row {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            gap: 12px;
        }

        .time-range-row .form-group {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            margin-bottom: 0;
        }

        .time-range-row input {
            width: 100%;
        }

        .drag-handle {
            cursor: grab;
            color: #666;
            padding: 8px;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            font-size: 1.2rem;
            margin-right: 8px;
        }
        .drag-handle:active { cursor: grabbing; }

        .draggable { cursor: grab; }
        .draggable.dragging {
            opacity: 0.4;
            -webkit-transition: opacity 0.2s;
            transition: opacity 0.2s;
        }
        .draggable.drag-over {
            border: 2px dashed #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            -webkit-border-radius: 12px;
            border-radius: 12px;
        }

        .stop-config.drag-over {
            border: 2px dashed #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            -webkit-border-radius: 12px;
            border-radius: 12px;
        }

        .drop-placeholder {
            border: 2px dashed #88a4ff;
            background: rgba(136, 164, 255, 0.1);
            min-height: 80px;
            margin-bottom: 12px;
            -webkit-border-radius: 12px;
            border-radius: 12px;
        }

        .stop-section {
            -webkit-transition: -webkit-transform 0.2s ease, box-shadow 0.2s ease;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .stop-section.dragging {
            -webkit-transition: -webkit-transform 0.2s ease, box-shadow 0.2s ease;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stop-section.collapsed {
            min-height: auto;
        }
        .stop-section.collapsed .departures {
            display: none;
        }
        .stop-section.collapsed .stop-header {
            border-bottom: none;
            padding-bottom: 8px;
        }

        .toggle-btn {
            display: -webkit-flex;
            display: flex;
            -webkit-align-items: center;
            align-items: center;
            -webkit-justify-content: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            text-align: center;
            cursor: pointer;
            font-size: 1.2rem;
            color: #888;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            transform: rotate(0deg);
            -webkit-transform: rotate(0deg);
            transition: transform 0.3s ease;
            -webkit-transition: -webkit-transform 0.3s ease;
        }
        .toggle-btn:hover {
            background: rgba(255,255,255,0.1);
            color: #aaa;
        }
        .toggle-btn.collapsed {
            transform: rotate(-90deg);
            -webkit-transform: rotate(-90deg);
        }

        .collapsed-indicator {
            font-size: 0.85rem;
            color: #888;
            background: #1a1a2e;
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            cursor: pointer;
        }
        .collapsed-indicator:hover {
            background: #16213e;
        }

        .settings-btn {
            position: relative;
        }
        .collapsed-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #ef4444;
            color: #fff;
            font-size: 0.7rem;
            font-weight: bold;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: none;
            -webkit-align-items: center;
            align-items: center;
            -webkit-justify-content: center;
            justify-content: center;
            border: 2px solid #1a1a2e;
        }
        .collapsed-badge.visible {
            display: -webkit-flex;
            display: flex;
        }

        .btn-collapse {
            background: #333;
            color: #fff;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 8px;
        }
        .btn-collapse:hover {
            background: #444;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <div class="title">Departures</div>
                <div class="status" id="status">Initializing...</div>
            </div>
            <div class="clock" id="clock">--:--</div>
        </header>
        <div class="stops-grid" id="stopsGrid">
            <div class="empty-state">
                <p>No stops configured yet.</p>
                <button class="btn btn-primary" onclick="openModal()">Add a Stop</button>
            </div>
        </div>
    </div>

    <button class="settings-btn" id="settingsBtn" onclick="openModal()">
        <span style="font-size: 1.5rem;">⚙</span>
        <span class="collapsed-badge" id="collapsedBadge">0</span>
    </button>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h2>Settings</h2>
            
            <h3>Stops</h3>
            <div style="margin-bottom: 12px;">
                <button class="btn-collapse" onclick="expandAllStops()">Expand All</button>
                <button class="btn-collapse" onclick="collapseAllStops()">Collapse All</button>
            </div>
            <div id="stopsConfig"></div>
            <button class="btn btn-add" onclick="addStopConfig()">+ Add Stop</button>

            <h3>General</h3>
            <div class="form-group">
                <label>Refresh interval (seconds)</label>
                <input type="number" id="refreshInterval" value="30" min="10" max="300">
            </div>
            <div class="form-group">
                <label>Departures per stop</label>
                <input type="number" id="maxDepartures" value="6" min="3" max="20">
            </div>

            <div class="btn-row">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveConfig()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Polyfill for padStart
        if (!String.prototype.padStart) {
            String.prototype.padStart = function(len, str) {
                var s = this;
                str = str || ' ';
                while (s.length < len) s = str + s;
                return s;
            };
        }

        // State
        var config = {
            stops: [],
            refreshInterval: 30,
            maxDepartures: 6
        };
        var refreshTimer = null;
        var searchTimeouts = {};

        // Load saved config
        function loadConfig() {
            try {
                var saved = localStorage.getItem('departures_config_v3');
                if (saved) {
                    var parsed = JSON.parse(saved);
                    config.stops = parsed.stops || [];
                    config.refreshInterval = parsed.refreshInterval || 30;
                    config.maxDepartures = parsed.maxDepartures || 6;

                    // Backward compatibility: ensure collapsed property exists
                    for (var i = 0; i < config.stops.length; i++) {
                        if (typeof config.stops[i].collapsed === 'undefined') {
                            config.stops[i].collapsed = false;
                        }
                    }
                }
            } catch (e) {
                console.error('Load config error:', e);
            }
            document.getElementById('refreshInterval').value = config.refreshInterval;
            document.getElementById('maxDepartures').value = config.maxDepartures;
        }

        // Save config
        function saveConfig() {
            config.refreshInterval = parseInt(document.getElementById('refreshInterval').value) || 30;
            config.maxDepartures = parseInt(document.getElementById('maxDepartures').value) || 6;

            // Gather stops from config UI
            config.stops = [];
            var stopEls = document.querySelectorAll('.stop-config');
            for (var i = 0; i < stopEls.length; i++) {
                var el = stopEls[i];
                var stopId = el.getAttribute('data-stop-id');
                var stopName = el.getAttribute('data-stop-name');
                var labelInput = el.querySelector('.stop-label-input');
                var platformDropdown = el.querySelector('.platform-dropdown');
                var timeFromInput = el.querySelector('.time-from-input');
                var timeToInput = el.querySelector('.time-to-input');
                var label = labelInput ? labelInput.value : stopName;
                var platformsStr = platformDropdown ? platformDropdown.getAttribute('data-selected') : '';
                var platforms = platformsStr ? platformsStr.split(',') : [];
                var timeFrom = timeFromInput ? parseInt(timeFromInput.value) || 0 : 0;
                var timeTo = timeToInput ? parseInt(timeToInput.value) || 60 : 60;
                if (stopId && stopName) {
                    config.stops.push({ id: stopId, name: stopName, label: label || stopName, platforms: platforms, timeFrom: timeFrom, timeTo: timeTo });
                }
            }

            localStorage.setItem('departures_config_v3', JSON.stringify(config));
            closeModal();
            renderStopsGrid();
            fetchAllDepartures();
            startRefreshTimer();
        }

        // Clock
        function updateClock() {
            var now = new Date();
            var h = String(now.getHours()).padStart(2, '0');
            var m = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('clock').textContent = h + ':' + m;
        }

        // Search stops via our proxy
        function searchStops(query, resultsContainerId) {
            var container = document.getElementById(resultsContainerId);
            if (!container) return;

            if (query.length < 3) {
                container.innerHTML = '<div class="search-result"><small>Type at least 3 characters...</small></div>';
                return;
            }

            container.innerHTML = '<div class="search-result"><small>Searching...</small></div>';

            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/stops?q=' + encodeURIComponent(query), true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            var stops = [];
                            
                            if (data.stopFinder && data.stopFinder.points) {
                                var points = data.stopFinder.points;
                                if (Array.isArray(points)) {
                                    stops = points;
                                } else if (points.point) {
                                    stops = Array.isArray(points.point) ? points.point : [points.point];
                                }
                            }

                            // Filter to actual stops
                            var filtered = [];
                            for (var i = 0; i < stops.length && filtered.length < 10; i++) {
                                var s = stops[i];
                                if (s.type === 'stop' || s.anyType === 'stop') {
                                    filtered.push(s);
                                }
                            }

                            if (filtered.length === 0) {
                                container.innerHTML = '<div class="search-result"><small>No stops found.</small></div>';
                                return;
                            }

                            var html = '';
                            for (var j = 0; j < filtered.length; j++) {
                                var stop = filtered[j];
                                var name = stop.name || stop.object || 'Unknown';
                                var id = stop.stateless || (stop.ref && stop.ref.id) || stop.id || '';
                                var locality = (stop.ref && stop.ref.place) || stop.locality || '';
                                html += '<div class="search-result" data-stop-id="' + escapeAttr(id) + '" data-stop-name="' + escapeAttr(name) + '">';
                                html += '<strong>' + escapeHtml(name) + '</strong>';
                                if (locality) html += '<br><small>' + escapeHtml(locality) + '</small>';
                                html += '</div>';
                            }
                            container.innerHTML = html;
                        } catch (e) {
                            container.innerHTML = '<div class="search-result"><small>Parse error</small></div>';
                        }
                    } else {
                        container.innerHTML = '<div class="search-result"><small>Error: ' + xhr.status + '</small></div>';
                    }
                }
            };
            xhr.send();
        }

        // Fetch departures for a stop
        function fetchDepartures(stop, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/departures?stop=' + encodeURIComponent(stop.id || stop.name), true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            callback(null, parseDepartures(data));
                        } catch (e) {
                            callback({ message: 'Failed to parse response', type: 'PARSE_ERROR' }, []);
                        }
                    } else {
                        // Try to extract error message from response
                        var errorMsg = 'HTTP ' + xhr.status;
                        var errorType = 'HTTP_ERROR';
                        try {
                            var errData = JSON.parse(xhr.responseText);
                            if (errData.error) {
                                errorMsg = errData.error;
                            }
                            if (errData.details && errData.details.type) {
                                errorType = errData.details.type;
                            }
                        } catch (e) {
                            // Could not parse error response
                        }
                        callback({ message: errorMsg, type: errorType, status: xhr.status }, []);
                    }
                }
            };
            xhr.send();
        }

        // Parse EFA departure response
        function parseDepartures(data) {
            var departures = [];
            var rawDeps = data.departureList || [];
            if (!Array.isArray(rawDeps)) {
                rawDeps = rawDeps ? [rawDeps] : [];
            }

            for (var i = 0; i < rawDeps.length; i++) {
                try {
                    var dep = rawDeps[i];
                    var servingLine = dep.servingLine || {};
                    var dateTime = dep.dateTime || {};
                    var realDateTime = dep.realDateTime || dateTime;
                    
                    var line = servingLine.number || servingLine.symbol || servingLine.name || '?';
                    var destination = servingLine.direction || servingLine.destName || 'Unknown';
                    var platform = dep.platform || dep.pointName || '';
                    var product = servingLine.motType || servingLine.code || 0;
                    
                    var schedHour = parseInt(dateTime.hour) || 0;
                    var schedMin = parseInt(dateTime.minute) || 0;
                    var realHour = parseInt(realDateTime.hour) || schedHour;
                    var realMin = parseInt(realDateTime.minute) || schedMin;
                    
                    var now = new Date();
                    var schedDate = new Date(now.getTime());
                    schedDate.setHours(schedHour, schedMin, 0, 0);
                    
                    var realDate = new Date(now.getTime());
                    realDate.setHours(realHour, realMin, 0, 0);
                    
                    if (schedDate < now && (now - schedDate) > 12 * 60 * 60 * 1000) {
                        schedDate.setDate(schedDate.getDate() + 1);
                    }
                    if (realDate < now && (now - realDate) > 12 * 60 * 60 * 1000) {
                        realDate.setDate(realDate.getDate() + 1);
                    }
                    
                    var minutes = Math.round((realDate - now) / 60000);
                    var delay = Math.round((realDate - schedDate) / 60000);
                    
                    if (minutes >= -1) {
                        departures.push({
                            line: line,
                            destination: destination,
                            platform: platform,
                            product: product,
                            minutes: minutes,
                            delay: delay > 0 ? delay : 0,
                            scheduledTime: String(schedHour).padStart(2, '0') + ':' + String(schedMin).padStart(2, '0')
                        });
                    }
                } catch (e) {
                    console.error('Parse error:', e);
                }
            }

            departures.sort(function(a, b) { return a.minutes - b.minutes; });
            return departures;
        }

        // Fetch all stops
        function fetchAllDepartures() {
            if (config.stops.length === 0) {
                setStatus('No stops configured', '');
                return;
            }

            setStatus('Updating...', '');
            var completed = 0;
            var totalToFetch = 0;
            var collapsedCount = 0;

            for (var i = 0; i < config.stops.length; i++) {
                if (config.stops[i].collapsed) {
                    collapsedCount++;
                    continue;
                }
                totalToFetch++;
            }

            if (collapsedCount > 0) {
                var now = new Date();
                var h = String(now.getHours()).padStart(2, '0');
                var m = String(now.getMinutes()).padStart(2, '0');
                setStatus('Last update: ' + h + ':' + m + ' (' + collapsedCount + ' collapsed)', 'online');
            }

            if (totalToFetch === 0) {
                setStatus('All stops collapsed', 'online');
                return;
            }

            for (var j = 0; j < config.stops.length; j++) {
                if (config.stops[j].collapsed) continue;

                (function(stop) {
                    var container = document.querySelector('[data-stop-container="' + stop.id + '"] .departures');
                    var statusEl = document.querySelector('[data-stop-container="' + stop.id + '"] .stop-status');

                    if (!container) {
                        completed++;
                        if (completed === totalToFetch) {
                            var now = new Date();
                            var h = String(now.getHours()).padStart(2, '0');
                            var m = String(now.getMinutes()).padStart(2, '0');
                            setStatus('Last update: ' + h + ':' + m + ' (' + collapsedCount + ' collapsed)', 'online');
                        }
                        return;
                    }

                    fetchDepartures(stop, function(err, departures) {
                        completed++;
                        if (err) {
                            var errorMsg = err.message || 'Unknown error';
                            container.innerHTML = '<div class="error-msg">' + escapeHtml(errorMsg) + '</div>';
                            if (statusEl) {
                                statusEl.textContent = err.type || 'Error';
                                statusEl.style.color = '#f87171';
                            }
                        } else {
                            // Filter by platforms if configured (supports both old and new format)
                            var stopPlatforms = stop.platforms || (stop.platform ? [stop.platform] : []);
                            if (stopPlatforms.length > 0) {
                                departures = departures.filter(function(dep) {
                                    return stopPlatforms.indexOf(dep.platform) !== -1;
                                });
                            }
                            // Filter by time range
                            var timeFrom = stop.timeFrom || 0;
                            var timeTo = stop.timeTo || 60;
                            departures = departures.filter(function(dep) {
                                return dep.minutes >= timeFrom && dep.minutes <= timeTo;
                            });
                            renderDepartures(container, departures);
                            if (statusEl) {
                                var now = new Date();
                                var h = String(now.getHours()).padStart(2, '0');
                                var m = String(now.getMinutes()).padStart(2, '0');
                                statusEl.textContent = 'Updated: ' + h + ':' + m;
                                statusEl.style.color = '#4ade80';
                            }
                        }

                        if (completed === totalToFetch) {
                            var now = new Date();
                            var h = String(now.getHours()).padStart(2, '0');
                            var m = String(now.getMinutes()).padStart(2, '0');
                            setStatus('Last update: ' + h + ':' + m + ' (' + collapsedCount + ' collapsed)', 'online');
                        }
                    });
                })(config.stops[j]);
            }
        }

        // Render departures for a stop
        function renderDepartures(container, departures) {
            if (!departures.length) {
                container.innerHTML = '<div class="loading">No departures found</div>';
                return;
            }

            var html = '';
            var count = Math.min(departures.length, config.maxDepartures);
            
            for (var i = 0; i < count; i++) {
                var dep = departures[i];
                var minuteClass = '';
                if (dep.minutes <= 0) minuteClass = 'now';
                else if (dep.minutes <= 3) minuteClass = 'soon';

                var lineClass = 'line-bus';
                var lineLower = dep.line.toLowerCase();
                var product = dep.product;
                
                if (lineLower.indexOf('u') === 0 || product === 2) lineClass = 'line-u';
                else if (lineLower.indexOf('s') === 0 || product === 1) lineClass = 'line-s';
                else if (product === 4 || product === 5) lineClass = 'line-str';
                else if (lineLower.indexOf('re') === 0 || lineLower.indexOf('rb') === 0 || product === 0) lineClass = 'line-re';

                html += '<div class="departure ' + lineClass + '">';
                html += '<div class="line">' + escapeHtml(dep.line) + '</div>';
                html += '<div class="dest-info">';
                html += '<div class="destination">' + escapeHtml(dep.destination) + '</div>';
                if (dep.platform) html += '<div class="platform">Platform ' + escapeHtml(dep.platform) + '</div>';
                html += '</div>';
                html += '<div class="time-info">';
                html += '<div class="minutes ' + minuteClass + '">' + (dep.minutes <= 0 ? 'now' : dep.minutes + ' min') + '</div>';
                html += '<div class="scheduled">' + dep.scheduledTime + '</div>';
                if (dep.delay > 0) html += '<div class="delay">+' + dep.delay + ' min</div>';
                html += '</div>';
                html += '</div>';
            }

            container.innerHTML = html;
        }

        // Render stops grid
        function renderStopsGrid() {
            var grid = document.getElementById('stopsGrid');

            if (config.stops.length === 0) {
                grid.innerHTML = '<div class="empty-state"><p>No stops configured yet.</p><button class="btn btn-primary" onclick="openModal()">Add a Stop</button></div>';
                return;
            }

            var collapsedCount = 0;
            var html = '';

            for (var i = 0; i < config.stops.length; i++) {
                var stop = config.stops[i];
                if (stop.collapsed) collapsedCount++;

                // Support both old 'platform' and new 'platforms' format
                var stopPlatforms = stop.platforms || (stop.platform ? [stop.platform] : []);
                var platformBadge = '';
                if (stopPlatforms.length === 1) {
                    platformBadge = '<span class="platform-badge">Platform ' + escapeHtml(stopPlatforms[0]) + '</span>';
                } else if (stopPlatforms.length > 1) {
                    platformBadge = '<span class="platform-badge">' + stopPlatforms.length + ' platforms</span>';
                }
                // Time range badge
                var timeFrom = stop.timeFrom || 0;
                var timeTo = stop.timeTo || 60;
                var timeBadge = '';
                if (timeFrom > 0 || timeTo !== 60) {
                    timeBadge = '<span class="time-badge">' + timeFrom + '-' + timeTo + ' min</span>';
                }

                var collapsedClass = stop.collapsed ? ' collapsed' : '';
                var toggleClass = stop.collapsed ? 'toggle-btn collapsed' : 'toggle-btn';
                var statusText = stop.collapsed ? 'Collapsed' : 'Loading...';

                html += '<div class="stop-section' + collapsedClass + '" data-stop-container="' + escapeAttr(stop.id) + '" data-stop-idx="' + i + '">';
                html += '<div class="stop-header">';
                html += '<div class="drag-handle">⋮⋮</div>';
                html += '<div class="' + toggleClass + '" onclick="toggleStopCollapse(' + i + ')">▼</div>';
                html += '<div class="stop-name">' + escapeHtml(stop.label || stop.name) + platformBadge + timeBadge + '</div>';
                html += '<div class="stop-status">' + statusText + '</div>';
                html += '</div>';
                html += '<div class="departures"><div class="loading">Loading departures...</div></div>';
                html += '</div>';
            }

            grid.innerHTML = html;

            // Update collapsed badge on settings button
            updateCollapsedBadge();

            // Make items draggable
            var sections = grid.querySelectorAll('.stop-section');
            for (var j = 0; j < sections.length; j++) {
                makeDraggable(sections[j], j, 'grid');
            }
        }

        // Render stops config in modal
        function renderStopsConfig() {
            var container = document.getElementById('stopsConfig');

            if (config.stops.length === 0) {
                container.innerHTML = '<p style="color: #888; margin-bottom: 12px;">No stops added yet.</p>';
                return;
            }

            var html = '';
            for (var i = 0; i < config.stops.length; i++) {
                var stop = config.stops[i];
                // Support both old 'platform' and new 'platforms' format
                var stopPlatforms = stop.platforms || (stop.platform ? [stop.platform] : []);
                var platformInfo = stopPlatforms.length > 0 ? ' · Platform ' + escapeHtml(stopPlatforms.join(', ')) : '';
                var timeFrom = stop.timeFrom || 0;
                var timeTo = stop.timeTo || 60;
                html += '<div class="stop-config" data-stop-id="' + escapeAttr(stop.id) + '" data-stop-name="' + escapeAttr(stop.name) + '" data-stop-idx="' + i + '">';
                html += '<div class="drag-handle">⋮⋮</div>';
                html += '<button class="remove-btn" onclick="removeStopConfig(' + i + ')">×</button>';
                html += '<div class="form-group">';
                html += '<label>Display label</label>';
                html += '<input type="text" class="stop-label-input" value="' + escapeAttr(stop.label || stop.name) + '" placeholder="Custom name">';
                html += '</div>';
                html += '<div class="form-group">';
                html += '<label>Platforms</label>';
                html += '<div class="platform-loading" id="platform-container-' + i + '">Loading platforms...</div>';
                html += '</div>';
                html += '<label style="display:block; margin-bottom:6px; color:#888; font-size:0.9rem;">Time range (minutes from now)</label>';
                html += '<div class="time-range-row">';
                html += '<div class="form-group">';
                html += '<label>From</label>';
                html += '<input type="number" class="time-from-input" value="' + timeFrom + '" min="0" max="480" placeholder="0">';
                html += '</div>';
                html += '<div class="form-group">';
                html += '<label>To</label>';
                html += '<input type="number" class="time-to-input" value="' + timeTo + '" min="1" max="480" placeholder="60">';
                html += '</div>';
                html += '</div>';
                html += '<div class="stop-info">Stop: ' + escapeHtml(stop.name) + platformInfo + '<br>ID: ' + escapeHtml(stop.id) + '</div>';
                html += '</div>';
            }
            container.innerHTML = html;

            // Make items draggable
            var configs = container.querySelectorAll('.stop-config');
            for (var j = 0; j < configs.length; j++) {
                makeDraggable(configs[j], j, 'config');
            }

            // Update collapsed badge
            updateCollapsedBadge();

            // Fetch platforms for each existing stop
            for (var j = 0; j < config.stops.length; j++) {
                (function(idx, stop) {
                    fetchPlatformsForStop(stop.id, function(err, platforms) {
                        var platformContainer = document.getElementById('platform-container-' + idx);
                        if (!platformContainer) return;

                        if (!err && platforms.length > 0) {
                            // Support both old 'platform' and new 'platforms' format
                            var selectedPlatforms = stop.platforms || (stop.platform ? [stop.platform] : []);
                            var selectedLabel = selectedPlatforms.length === 0 ? 'All platforms' :
                                selectedPlatforms.length === 1 ? 'Platform ' + escapeHtml(selectedPlatforms[0]) :
                                selectedPlatforms.length + ' platforms';
                            var dropdownHtml = '<div class="platform-dropdown" data-selected="' + escapeAttr(selectedPlatforms.join(',')) + '">' +
                                '<div class="platform-selected">' + selectedLabel + '</div>' +
                                '<div class="platform-options">';
                            for (var k = 0; k < platforms.length; k++) {
                                var isSelected = selectedPlatforms.indexOf(platforms[k]) !== -1 ? ' selected' : '';
                                dropdownHtml += '<div class="platform-option' + isSelected + '" data-value="' + escapeAttr(platforms[k]) + '">Platform ' + escapeHtml(platforms[k]) + '</div>';
                            }
                            dropdownHtml += '</div></div>';
                            platformContainer.outerHTML = dropdownHtml;
                        } else {
                            platformContainer.textContent = 'No platforms found';
                        }
                    });
                })(j, config.stops[j]);
            }
        }

        // Add stop config UI
        function addStopConfig() {
            var container = document.getElementById('stopsConfig');
            var idx = Date.now();
            
            var div = document.createElement('div');
            div.className = 'stop-config';
            div.innerHTML = '<button class="remove-btn" onclick="this.parentElement.parentElement.removeChild(this.parentElement)">×</button>' +
                '<div class="form-group">' +
                '<label>Search for stop</label>' +
                '<input type="text" class="stop-search-input" placeholder="e.g. Düsseldorf Hbf" oninput="handleStopSearch(this, \'results-' + idx + '\')">' +
                '<div class="search-results" id="results-' + idx + '"></div>' +
                '</div>';
            container.appendChild(div);
        }

        // Remove stop config
        function removeStopConfig(idx) {
            config.stops.splice(idx, 1);
            localStorage.setItem('departures_config_v3', JSON.stringify(config));
            renderStopsConfig();
            renderStopsGrid();
            fetchAllDepartures();
        }

        // Handle stop search input
        function handleStopSearch(input, resultsId) {
            if (searchTimeouts[resultsId]) clearTimeout(searchTimeouts[resultsId]);
            searchTimeouts[resultsId] = setTimeout(function() {
                searchStops(input.value, resultsId);
            }, 400);
        }

        // Fetch available platforms for a stop
        function fetchPlatformsForStop(stopId, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/departures?stop=' + encodeURIComponent(stopId), true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            var platforms = [];
                            var seen = {};
                            var rawDeps = data.departureList || [];
                            if (!Array.isArray(rawDeps)) {
                                rawDeps = rawDeps ? [rawDeps] : [];
                            }
                            for (var i = 0; i < rawDeps.length; i++) {
                                var platform = rawDeps[i].platform || rawDeps[i].pointName || '';
                                if (platform && !seen[platform]) {
                                    seen[platform] = true;
                                    platforms.push(platform);
                                }
                            }
                            platforms.sort(function(a, b) {
                                var numA = parseInt(a);
                                var numB = parseInt(b);
                                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                                return a.localeCompare(b);
                            });
                            callback(null, platforms);
                        } catch (e) {
                            callback(e, []);
                        }
                    } else {
                        callback(new Error('HTTP ' + xhr.status), []);
                    }
                }
            };
            xhr.send();
        }

        // Render platform selector dropdown (multi-select)
        function renderPlatformSelector(container, platforms, selectedPlatforms) {
            // Ensure selectedPlatforms is an array
            if (!selectedPlatforms) selectedPlatforms = [];
            if (typeof selectedPlatforms === 'string') {
                selectedPlatforms = selectedPlatforms ? [selectedPlatforms] : [];
            }

            var selectedLabel = selectedPlatforms.length === 0 ? 'All platforms' :
                selectedPlatforms.length === 1 ? 'Platform ' + escapeHtml(selectedPlatforms[0]) :
                selectedPlatforms.length + ' platforms';

            var html = '<div class="form-group">' +
                '<label>Platforms</label>' +
                '<div class="platform-dropdown" data-selected="' + escapeAttr(selectedPlatforms.join(',')) + '">' +
                '<div class="platform-selected">' + selectedLabel + '</div>' +
                '<div class="platform-options">';
            for (var i = 0; i < platforms.length; i++) {
                var isSelected = selectedPlatforms.indexOf(platforms[i]) !== -1 ? ' selected' : '';
                html += '<div class="platform-option' + isSelected + '" data-value="' + escapeAttr(platforms[i]) + '">Platform ' + escapeHtml(platforms[i]) + '</div>';
            }
            html += '</div></div></div>';
            return html;
        }

        // Handle click on search result
        document.addEventListener('click', function(e) {
            var result = e.target;
            while (result && !result.classList.contains('search-result')) {
                result = result.parentElement;
            }
            if (result && result.getAttribute('data-stop-id')) {
                var stopConfig = result;
                while (stopConfig && !stopConfig.classList.contains('stop-config')) {
                    stopConfig = stopConfig.parentElement;
                }
                if (stopConfig) {
                    var stopId = result.getAttribute('data-stop-id');
                    var stopName = result.getAttribute('data-stop-name');
                    stopConfig.setAttribute('data-stop-id', stopId);
                    stopConfig.setAttribute('data-stop-name', stopName);

                    // Show loading state while fetching platforms
                    stopConfig.innerHTML = '<button class="remove-btn" onclick="this.parentElement.parentElement.removeChild(this.parentElement)">×</button>' +
                        '<div class="form-group">' +
                        '<label>Display label</label>' +
                        '<input type="text" class="stop-label-input" value="' + escapeAttr(stopName) + '" placeholder="Custom name">' +
                        '</div>' +
                        '<div class="platform-loading">Loading platforms...</div>' +
                        '<div class="stop-info">Stop: ' + escapeHtml(stopName) + '<br>ID: ' + escapeHtml(stopId) + '</div>';

                    // Fetch platforms and update UI
                    fetchPlatformsForStop(stopId, function(err, platforms) {
                        var platformHtml = '';
                        if (!err && platforms.length > 0) {
                            platformHtml = renderPlatformSelector(stopConfig, platforms, '');
                        } else if (platforms.length === 0) {
                            platformHtml = '<div class="form-group"><label>Platform</label><div class="platform-loading">No platforms found</div></div>';
                        }

                        var timeRangeHtml = '<label style="display:block; margin-bottom:6px; color:#888; font-size:0.9rem;">Time range (minutes from now)</label>' +
                            '<div class="time-range-row">' +
                            '<div class="form-group">' +
                            '<label>From</label>' +
                            '<input type="number" class="time-from-input" value="0" min="0" max="480" placeholder="0">' +
                            '</div>' +
                            '<div class="form-group">' +
                            '<label>To</label>' +
                            '<input type="number" class="time-to-input" value="60" min="1" max="480" placeholder="60">' +
                            '</div>' +
                            '</div>';

                        stopConfig.innerHTML = '<button class="remove-btn" onclick="this.parentElement.parentElement.removeChild(this.parentElement)">×</button>' +
                            '<div class="form-group">' +
                            '<label>Display label</label>' +
                            '<input type="text" class="stop-label-input" value="' + escapeAttr(stopName) + '" placeholder="Custom name">' +
                            '</div>' +
                            platformHtml +
                            timeRangeHtml +
                            '<div class="stop-info">Stop: ' + escapeHtml(stopName) + '<br>ID: ' + escapeHtml(stopId) + '</div>';
                    });
                }
            }
        }, false);

        // Handle click on platform dropdown
        document.addEventListener('click', function(e) {
            var target = e.target;

            // Check if clicked on platform-selected (toggle dropdown)
            if (target.classList.contains('platform-selected')) {
                var dropdown = target.parentElement;
                dropdown.classList.toggle('open');
                e.stopPropagation();
                return;
            }

            // Check if clicked on platform-option (toggle multi-select)
            if (target.classList.contains('platform-option')) {
                var dropdown = target.parentElement;
                while (dropdown && !dropdown.classList.contains('platform-dropdown')) {
                    dropdown = dropdown.parentElement;
                }
                if (!dropdown) return;
                var value = target.getAttribute('data-value');

                // Toggle selection
                if (target.classList.contains('selected')) {
                    target.classList.remove('selected');
                } else {
                    target.classList.add('selected');
                }

                // Gather all selected values
                var selectedOptions = dropdown.querySelectorAll('.platform-option.selected');
                var selectedValues = [];
                for (var i = 0; i < selectedOptions.length; i++) {
                    var val = selectedOptions[i].getAttribute('data-value');
                    if (val) selectedValues.push(val);
                }

                // Update data-selected attribute
                dropdown.setAttribute('data-selected', selectedValues.join(','));

                // Update display label
                var label = selectedValues.length === 0 ? 'All platforms' :
                    selectedValues.length === 1 ? 'Platform ' + selectedValues[0] :
                    selectedValues.length + ' platforms';
                dropdown.querySelector('.platform-selected').textContent = label;

                e.stopPropagation();
                return;
            }

            // Close any open dropdowns when clicking outside
            var openDropdowns = document.querySelectorAll('.platform-dropdown.open');
            for (var j = 0; j < openDropdowns.length; j++) {
                openDropdowns[j].classList.remove('open');
            }
        }, false);

        // Helper: Escape HTML
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        function escapeAttr(str) {
            return escapeHtml(str);
        }

        // Status
        function setStatus(text, state) {
            var el = document.getElementById('status');
            el.textContent = text;
            el.className = 'status ' + (state || '');
        }

        // Modal
        function openModal() {
            renderStopsConfig();
            document.getElementById('modal').className = 'modal open';
        }

        function closeModal() {
            document.getElementById('modal').className = 'modal';
        }

        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === document.getElementById('modal')) closeModal();
        }, false);

        // Refresh timer
        function startRefreshTimer() {
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(fetchAllDepartures, config.refreshInterval * 1000);
        }

        // Initialize
        loadConfig();
        updateClock();
        setInterval(updateClock, 1000);
        renderStopsGrid();
        fetchAllDepartures();
        startRefreshTimer();

        // Drag and Drop System
        var draggedItem = null;
        var dragSource = null;
        var touchStartY = 0;
        var touchDragItem = null;

        // Polyfill for closest() for older iOS
        if (!Element.prototype.closest) {
            Element.prototype.closest = function(selector) {
                var node = this;
                while (node) {
                    if (node.matches && node.matches(selector)) return node;
                    node = node.parentNode;
                }
                return null;
            };
        }

        function closestByClass(el, className) {
            while (el && el.className) {
                if (el.className.indexOf(className) !== -1) return el;
                el = el.parentNode;
            }
            return null;
        }

        function addTouchListener(el, type, handler) {
            el.addEventListener(type, handler);
        }

        function makeDraggable(el, index, source) {
            el.setAttribute('draggable', 'true');
            el.setAttribute('data-dnd-index', index);
            el.setAttribute('data-dnd-source', source);
            el.classList.add('draggable');

            el.addEventListener('dragstart', handleDragStart, false);
            el.addEventListener('dragend', handleDragEnd, false);
            el.addEventListener('dragover', handleDragOver, false);
            el.addEventListener('drop', handleDrop, false);
            el.addEventListener('dragenter', handleDragEnter, false);
            el.addEventListener('dragleave', handleDragLeave, false);

            addTouchListener(el, 'touchstart', handleTouchStart);
            addTouchListener(el, 'touchmove', handleTouchMove);
            addTouchListener(el, 'touchend', handleTouchEnd);
        }

        function handleDragStart(e) {
            draggedItem = this;
            dragSource = this.getAttribute('data-dnd-source');
            e.dataTransfer.setData('text/plain', this.getAttribute('data-dnd-index'));
            e.dataTransfer.effectAllowed = 'move';
            setTimeout(function() { this.classList.add('dragging'); }, 0);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            var dragOvers = document.querySelectorAll('.drag-over');
            for (var i = 0; i < dragOvers.length; i++) {
                dragOvers[i].classList.remove('drag-over');
            }
            draggedItem = null;
            dragSource = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (this !== draggedItem) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();

            if (this === draggedItem) return;

            var fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
            var toIdx = parseInt(this.getAttribute('data-dnd-index'));

            if (!isNaN(fromIdx) && !isNaN(toIdx) && fromIdx !== toIdx) {
                reorderStops(fromIdx, toIdx, dragSource);
            }
        }

        function handleTouchStart(e) {
            if (e.touches.length > 1) return;
            touchDragItem = this;
            var touch = e.touches[0];
            touchStartY = touch.clientY;
            this.classList.add('dragging');
            e.preventDefault();
        }

        function handleTouchMove(e) {
            if (!touchDragItem) return;
            e.preventDefault();

            var touch = e.touches[0];
            var target = document.elementFromPoint(touch.clientX, touch.clientY);
            var dropTarget = closestByClass(target, 'draggable');

            var dragOvers = document.querySelectorAll('.drag-over');
            for (var i = 0; i < dragOvers.length; i++) {
                dragOvers[i].classList.remove('drag-over');
            }

            if (dropTarget && dropTarget !== touchDragItem) {
                dropTarget.classList.add('drag-over');
            }
        }

        function handleTouchEnd(e) {
            if (!touchDragItem) return;

            var touch = e.changedTouches[0];
            var target = document.elementFromPoint(touch.clientX, touch.clientY);
            var dropTarget = closestByClass(target, 'draggable');

            if (dropTarget && dropTarget !== touchDragItem) {
                var fromIdx = parseInt(touchDragItem.getAttribute('data-dnd-index'));
                var toIdx = parseInt(dropTarget.getAttribute('data-dnd-index'));
                if (!isNaN(fromIdx) && !isNaN(toIdx) && fromIdx !== toIdx) {
                    reorderStops(fromIdx, toIdx, touchDragItem.getAttribute('data-dnd-source'));
                }
            }

            touchDragItem.classList.remove('dragging');
            var dragOvers = document.querySelectorAll('.drag-over');
            for (var i = 0; i < dragOvers.length; i++) {
                dragOvers[i].classList.remove('drag-over');
            }
            touchDragItem = null;
        }

        function updateCollapsedBadge() {
            var count = 0;
            for (var i = 0; i < config.stops.length; i++) {
                if (config.stops[i].collapsed) count++;
            }
            var badge = document.getElementById('collapsedBadge');
            if (badge) {
                badge.textContent = count;
                if (count > 0) {
                    badge.classList.add('visible');
                } else {
                    badge.classList.remove('visible');
                }
            }
        }

        function reorderStops(fromIdx, toIdx, source) {
            var item = config.stops.splice(fromIdx, 1)[0];
            config.stops.splice(toIdx, 0, item);

            localStorage.setItem('departures_config_v3', JSON.stringify(config));

            if (source === 'config') {
                renderStopsConfig();
            } else {
                renderStopsGrid();
                fetchAllDepartures();
            }
        }

        function toggleStopCollapse(index) {
            if (config.stops[index]) {
                config.stops[index].collapsed = !config.stops[index].collapsed;
                localStorage.setItem('departures_config_v3', JSON.stringify(config));
                renderStopsGrid();
                fetchAllDepartures();
            }
        }

        function collapseAllStops() {
            for (var i = 0; i < config.stops.length; i++) {
                config.stops[i].collapsed = true;
            }
            localStorage.setItem('departures_config_v3', JSON.stringify(config));
            renderStopsConfig();
            renderStopsGrid();
            fetchAllDepartures();
        }

        function expandAllStops() {
            for (var i = 0; i < config.stops.length; i++) {
                config.stops[i].collapsed = false;
            }
            localStorage.setItem('departures_config_v3', JSON.stringify(config));
            renderStopsConfig();
            renderStopsGrid();
            fetchAllDepartures();
        }
    </script>
</body>
</html>
