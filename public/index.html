<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>Departures</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            -webkit-align-items: center;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #333;
        }

        .title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .clock {
            font-size: 2rem;
            font-weight: 300;
        }

        .status {
            font-size: 0.75rem;
            color: #666;
            margin-top: 4px;
        }

        .status.online { color: #4ade80; }
        .status.error { color: #f87171; }

        .stops-grid {
            display: -webkit-flex;
            display: flex;
            -webkit-flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 24px;
        }

        .stop-section {
            background: #0f0f1a;
            border-radius: 16px;
            padding: 16px;
            -webkit-flex: 1 1 350px;
            flex: 1 1 350px;
            min-width: 300px;
        }

        .stop-header {
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            -webkit-align-items: center;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #333;
        }

        .stop-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #88a4ff;
        }

        .stop-status {
            font-size: 0.7rem;
            color: #666;
        }

        .departures {
            display: -webkit-flex;
            display: flex;
            -webkit-flex-direction: column;
            flex-direction: column;
        }

        .departure {
            display: -webkit-flex;
            display: flex;
            -webkit-align-items: center;
            align-items: center;
            padding: 12px;
            background: #16213e;
            border-radius: 10px;
            border-left: 4px solid #666;
            margin-bottom: 10px;
        }

        .departure.line-u { border-left-color: #0063af; }
        .departure.line-s { border-left-color: #008d4f; }
        .departure.line-str { border-left-color: #be1622; }
        .departure.line-bus { border-left-color: #7b2d8e; }
        .departure.line-re { border-left-color: #ec1c24; }

        .line {
            font-size: 1.2rem;
            font-weight: 700;
            text-align: center;
            padding: 6px;
            border-radius: 6px;
            background: #666;
            color: #fff;
            min-width: 50px;
            margin-right: 12px;
        }

        .departure.line-u .line { background: #0063af; }
        .departure.line-s .line { background: #008d4f; }
        .departure.line-str .line { background: #be1622; }
        .departure.line-bus .line { background: #7b2d8e; }
        .departure.line-re .line { background: #ec1c24; }

        .dest-info {
            -webkit-flex: 1;
            flex: 1;
            min-width: 0;
        }

        .destination {
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .platform {
            font-size: 0.75rem;
            color: #888;
            margin-top: 2px;
        }

        .time-info {
            text-align: right;
            margin-left: 12px;
        }

        .minutes {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .minutes.soon { color: #fbbf24; }
        .minutes.now { color: #4ade80; }

        .scheduled {
            font-size: 0.75rem;
            color: #888;
        }

        .delay {
            color: #f87171;
            font-size: 0.7rem;
        }

        .loading, .error-msg {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }

        .error-msg { color: #f87171; }

        .settings-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #16213e;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: -webkit-flex;
            display: flex;
            -webkit-align-items: center;
            align-items: center;
            -webkit-justify-content: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            color: #888;
            font-size: 1.5rem;
            z-index: 100;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            -webkit-align-items: flex-start;
            align-items: flex-start;
            -webkit-justify-content: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
            z-index: 200;
        }

        .modal.open { 
            display: -webkit-flex;
            display: flex; 
        }

        .modal-content {
            background: #16213e;
            padding: 24px;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            margin: 40px 0;
        }

        .modal h2 {
            margin-bottom: 20px;
        }

        .modal h3 {
            margin: 20px 0 12px;
            font-size: 1rem;
            color: #88a4ff;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #888;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #1a1a2e;
            color: #fff;
            font-size: 16px; /* Prevents zoom on iOS */
        }

        .stop-config {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
        }

        .stop-config .remove-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #f87171;
            border: none;
            color: #fff;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            line-height: 24px;
        }

        .search-results {
            max-height: 200px;
            overflow-y: auto;
            background: #0f0f1a;
            border-radius: 8px;
            margin-top: 8px;
        }

        .search-result {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #333;
        }

        .search-result small {
            color: #666;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 8px;
        }

        .btn-primary {
            background: #3b82f6;
            color: #fff;
        }

        .btn-secondary {
            background: #333;
            color: #fff;
            margin-right: 8px;
        }

        .btn-add {
            background: #22c55e;
            color: #fff;
            width: 100%;
            margin-bottom: 16px;
        }

        .btn-row {
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: flex-end;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            width: 100%;
        }

        .empty-state p {
            margin-bottom: 16px;
        }

        .stop-info {
            font-size: 0.8rem;
            color: #666;
        }

        .platform-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #1a1a2e;
            color: #fff;
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .platform-loading {
            padding: 12px;
            color: #888;
            font-size: 0.9rem;
        }

        .platform-badge {
            font-size: 0.75rem;
            color: #fbbf24;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <div class="title">Departures</div>
                <div class="status" id="status">Initializing...</div>
            </div>
            <div class="clock" id="clock">--:--</div>
        </header>
        <div class="stops-grid" id="stopsGrid">
            <div class="empty-state">
                <p>No stops configured yet.</p>
                <button class="btn btn-primary" onclick="openModal()">Add a Stop</button>
            </div>
        </div>
    </div>

    <button class="settings-btn" id="settingsBtn" onclick="openModal()">⚙</button>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h2>Settings</h2>
            
            <h3>Stops</h3>
            <div id="stopsConfig"></div>
            <button class="btn btn-add" onclick="addStopConfig()">+ Add Stop</button>

            <h3>General</h3>
            <div class="form-group">
                <label>Refresh interval (seconds)</label>
                <input type="number" id="refreshInterval" value="30" min="10" max="300">
            </div>
            <div class="form-group">
                <label>Departures per stop</label>
                <input type="number" id="maxDepartures" value="6" min="3" max="20">
            </div>

            <div class="btn-row">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveConfig()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Polyfill for padStart
        if (!String.prototype.padStart) {
            String.prototype.padStart = function(len, str) {
                var s = this;
                str = str || ' ';
                while (s.length < len) s = str + s;
                return s;
            };
        }

        // State
        var config = {
            stops: [],
            refreshInterval: 30,
            maxDepartures: 6
        };
        var refreshTimer = null;
        var searchTimeouts = {};

        // Load saved config
        function loadConfig() {
            try {
                var saved = localStorage.getItem('departures_config_v3');
                if (saved) {
                    var parsed = JSON.parse(saved);
                    config.stops = parsed.stops || [];
                    config.refreshInterval = parsed.refreshInterval || 30;
                    config.maxDepartures = parsed.maxDepartures || 6;
                }
            } catch (e) {
                console.error('Load config error:', e);
            }
            document.getElementById('refreshInterval').value = config.refreshInterval;
            document.getElementById('maxDepartures').value = config.maxDepartures;
        }

        // Save config
        function saveConfig() {
            config.refreshInterval = parseInt(document.getElementById('refreshInterval').value) || 30;
            config.maxDepartures = parseInt(document.getElementById('maxDepartures').value) || 6;

            // Gather stops from config UI
            config.stops = [];
            var stopEls = document.querySelectorAll('.stop-config');
            for (var i = 0; i < stopEls.length; i++) {
                var el = stopEls[i];
                var stopId = el.getAttribute('data-stop-id');
                var stopName = el.getAttribute('data-stop-name');
                var labelInput = el.querySelector('.stop-label-input');
                var platformSelect = el.querySelector('.platform-select');
                var label = labelInput ? labelInput.value : stopName;
                var platform = platformSelect ? platformSelect.value : '';
                if (stopId && stopName) {
                    config.stops.push({ id: stopId, name: stopName, label: label || stopName, platform: platform });
                }
            }

            localStorage.setItem('departures_config_v3', JSON.stringify(config));
            closeModal();
            renderStopsGrid();
            fetchAllDepartures();
            startRefreshTimer();
        }

        // Clock
        function updateClock() {
            var now = new Date();
            var h = String(now.getHours()).padStart(2, '0');
            var m = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('clock').textContent = h + ':' + m;
        }

        // Search stops via our proxy
        function searchStops(query, resultsContainerId) {
            var container = document.getElementById(resultsContainerId);
            if (!container) return;

            if (query.length < 3) {
                container.innerHTML = '<div class="search-result"><small>Type at least 3 characters...</small></div>';
                return;
            }

            container.innerHTML = '<div class="search-result"><small>Searching...</small></div>';

            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/stops?q=' + encodeURIComponent(query), true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            var stops = [];
                            
                            if (data.stopFinder && data.stopFinder.points) {
                                var points = data.stopFinder.points;
                                if (Array.isArray(points)) {
                                    stops = points;
                                } else if (points.point) {
                                    stops = Array.isArray(points.point) ? points.point : [points.point];
                                }
                            }

                            // Filter to actual stops
                            var filtered = [];
                            for (var i = 0; i < stops.length && filtered.length < 10; i++) {
                                var s = stops[i];
                                if (s.type === 'stop' || s.anyType === 'stop') {
                                    filtered.push(s);
                                }
                            }

                            if (filtered.length === 0) {
                                container.innerHTML = '<div class="search-result"><small>No stops found.</small></div>';
                                return;
                            }

                            var html = '';
                            for (var j = 0; j < filtered.length; j++) {
                                var stop = filtered[j];
                                var name = stop.name || stop.object || 'Unknown';
                                var id = stop.stateless || (stop.ref && stop.ref.id) || stop.id || '';
                                var locality = (stop.ref && stop.ref.place) || stop.locality || '';
                                html += '<div class="search-result" data-stop-id="' + escapeAttr(id) + '" data-stop-name="' + escapeAttr(name) + '">';
                                html += '<strong>' + escapeHtml(name) + '</strong>';
                                if (locality) html += '<br><small>' + escapeHtml(locality) + '</small>';
                                html += '</div>';
                            }
                            container.innerHTML = html;
                        } catch (e) {
                            container.innerHTML = '<div class="search-result"><small>Parse error</small></div>';
                        }
                    } else {
                        container.innerHTML = '<div class="search-result"><small>Error: ' + xhr.status + '</small></div>';
                    }
                }
            };
            xhr.send();
        }

        // Fetch departures for a stop
        function fetchDepartures(stop, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/departures?stop=' + encodeURIComponent(stop.id || stop.name), true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            callback(null, parseDepartures(data));
                        } catch (e) {
                            callback(e, []);
                        }
                    } else {
                        callback(new Error('HTTP ' + xhr.status), []);
                    }
                }
            };
            xhr.send();
        }

        // Parse EFA departure response
        function parseDepartures(data) {
            var departures = [];
            var rawDeps = data.departureList || [];
            if (!Array.isArray(rawDeps)) {
                rawDeps = rawDeps ? [rawDeps] : [];
            }

            for (var i = 0; i < rawDeps.length; i++) {
                try {
                    var dep = rawDeps[i];
                    var servingLine = dep.servingLine || {};
                    var dateTime = dep.dateTime || {};
                    var realDateTime = dep.realDateTime || dateTime;
                    
                    var line = servingLine.number || servingLine.symbol || servingLine.name || '?';
                    var destination = servingLine.direction || servingLine.destName || 'Unknown';
                    var platform = dep.platform || dep.pointName || '';
                    var product = servingLine.motType || servingLine.code || 0;
                    
                    var schedHour = parseInt(dateTime.hour) || 0;
                    var schedMin = parseInt(dateTime.minute) || 0;
                    var realHour = parseInt(realDateTime.hour) || schedHour;
                    var realMin = parseInt(realDateTime.minute) || schedMin;
                    
                    var now = new Date();
                    var schedDate = new Date(now.getTime());
                    schedDate.setHours(schedHour, schedMin, 0, 0);
                    
                    var realDate = new Date(now.getTime());
                    realDate.setHours(realHour, realMin, 0, 0);
                    
                    if (schedDate < now && (now - schedDate) > 12 * 60 * 60 * 1000) {
                        schedDate.setDate(schedDate.getDate() + 1);
                    }
                    if (realDate < now && (now - realDate) > 12 * 60 * 60 * 1000) {
                        realDate.setDate(realDate.getDate() + 1);
                    }
                    
                    var minutes = Math.round((realDate - now) / 60000);
                    var delay = Math.round((realDate - schedDate) / 60000);
                    
                    if (minutes >= -1) {
                        departures.push({
                            line: line,
                            destination: destination,
                            platform: platform,
                            product: product,
                            minutes: minutes,
                            delay: delay > 0 ? delay : 0,
                            scheduledTime: String(schedHour).padStart(2, '0') + ':' + String(schedMin).padStart(2, '0')
                        });
                    }
                } catch (e) {
                    console.error('Parse error:', e);
                }
            }

            departures.sort(function(a, b) { return a.minutes - b.minutes; });
            return departures;
        }

        // Fetch all stops
        function fetchAllDepartures() {
            if (config.stops.length === 0) {
                setStatus('No stops configured', '');
                return;
            }

            setStatus('Updating...', '');
            var completed = 0;
            
            for (var i = 0; i < config.stops.length; i++) {
                (function(stop) {
                    var container = document.querySelector('[data-stop-container="' + stop.id + '"] .departures');
                    var statusEl = document.querySelector('[data-stop-container="' + stop.id + '"] .stop-status');
                    
                    if (!container) {
                        completed++;
                        return;
                    }

                    fetchDepartures(stop, function(err, departures) {
                        completed++;
                        if (err) {
                            container.innerHTML = '<div class="error-msg">Error loading data</div>';
                            if (statusEl) {
                                statusEl.textContent = 'Error';
                                statusEl.style.color = '#f87171';
                            }
                        } else {
                            // Filter by platform if configured
                            if (stop.platform) {
                                departures = departures.filter(function(dep) {
                                    return dep.platform === stop.platform;
                                });
                            }
                            renderDepartures(container, departures);
                            if (statusEl) {
                                var now = new Date();
                                var h = String(now.getHours()).padStart(2, '0');
                                var m = String(now.getMinutes()).padStart(2, '0');
                                statusEl.textContent = 'Updated: ' + h + ':' + m;
                                statusEl.style.color = '#4ade80';
                            }
                        }
                        
                        if (completed === config.stops.length) {
                            var now = new Date();
                            var h = String(now.getHours()).padStart(2, '0');
                            var m = String(now.getMinutes()).padStart(2, '0');
                            setStatus('Last update: ' + h + ':' + m, 'online');
                        }
                    });
                })(config.stops[i]);
            }
        }

        // Render departures for a stop
        function renderDepartures(container, departures) {
            if (!departures.length) {
                container.innerHTML = '<div class="loading">No departures found</div>';
                return;
            }

            var html = '';
            var count = Math.min(departures.length, config.maxDepartures);
            
            for (var i = 0; i < count; i++) {
                var dep = departures[i];
                var minuteClass = '';
                if (dep.minutes <= 0) minuteClass = 'now';
                else if (dep.minutes <= 3) minuteClass = 'soon';

                var lineClass = 'line-bus';
                var lineLower = dep.line.toLowerCase();
                var product = dep.product;
                
                if (lineLower.indexOf('u') === 0 || product === 2) lineClass = 'line-u';
                else if (lineLower.indexOf('s') === 0 || product === 1) lineClass = 'line-s';
                else if (product === 4 || product === 5) lineClass = 'line-str';
                else if (lineLower.indexOf('re') === 0 || lineLower.indexOf('rb') === 0 || product === 0) lineClass = 'line-re';

                html += '<div class="departure ' + lineClass + '">';
                html += '<div class="line">' + escapeHtml(dep.line) + '</div>';
                html += '<div class="dest-info">';
                html += '<div class="destination">' + escapeHtml(dep.destination) + '</div>';
                if (dep.platform) html += '<div class="platform">Platform ' + escapeHtml(dep.platform) + '</div>';
                html += '</div>';
                html += '<div class="time-info">';
                html += '<div class="minutes ' + minuteClass + '">' + (dep.minutes <= 0 ? 'now' : dep.minutes + ' min') + '</div>';
                html += '<div class="scheduled">' + dep.scheduledTime + '</div>';
                if (dep.delay > 0) html += '<div class="delay">+' + dep.delay + ' min</div>';
                html += '</div>';
                html += '</div>';
            }

            container.innerHTML = html;
        }

        // Render stops grid
        function renderStopsGrid() {
            var grid = document.getElementById('stopsGrid');

            if (config.stops.length === 0) {
                grid.innerHTML = '<div class="empty-state"><p>No stops configured yet.</p><button class="btn btn-primary" onclick="openModal()">Add a Stop</button></div>';
                return;
            }

            var html = '';
            for (var i = 0; i < config.stops.length; i++) {
                var stop = config.stops[i];
                var platformBadge = stop.platform ? '<span class="platform-badge">Platform ' + escapeHtml(stop.platform) + '</span>' : '';
                html += '<div class="stop-section" data-stop-container="' + escapeAttr(stop.id) + '">';
                html += '<div class="stop-header">';
                html += '<div class="stop-name">' + escapeHtml(stop.label || stop.name) + platformBadge + '</div>';
                html += '<div class="stop-status">Loading...</div>';
                html += '</div>';
                html += '<div class="departures"><div class="loading">Loading departures...</div></div>';
                html += '</div>';
            }
            grid.innerHTML = html;
        }

        // Render stops config in modal
        function renderStopsConfig() {
            var container = document.getElementById('stopsConfig');

            if (config.stops.length === 0) {
                container.innerHTML = '<p style="color: #888; margin-bottom: 12px;">No stops added yet.</p>';
                return;
            }

            var html = '';
            for (var i = 0; i < config.stops.length; i++) {
                var stop = config.stops[i];
                var platformInfo = stop.platform ? ' · Platform ' + escapeHtml(stop.platform) : '';
                html += '<div class="stop-config" data-stop-id="' + escapeAttr(stop.id) + '" data-stop-name="' + escapeAttr(stop.name) + '" data-stop-platform="' + escapeAttr(stop.platform || '') + '" data-stop-idx="' + i + '">';
                html += '<button class="remove-btn" onclick="removeStopConfig(' + i + ')">×</button>';
                html += '<div class="form-group">';
                html += '<label>Display label</label>';
                html += '<input type="text" class="stop-label-input" value="' + escapeAttr(stop.label || stop.name) + '" placeholder="Custom name">';
                html += '</div>';
                html += '<div class="form-group">';
                html += '<label>Platform</label>';
                html += '<div class="platform-loading" id="platform-container-' + i + '">Loading platforms...</div>';
                html += '</div>';
                html += '<div class="stop-info">Stop: ' + escapeHtml(stop.name) + platformInfo + '<br>ID: ' + escapeHtml(stop.id) + '</div>';
                html += '</div>';
            }
            container.innerHTML = html;

            // Fetch platforms for each existing stop
            for (var j = 0; j < config.stops.length; j++) {
                (function(idx, stop) {
                    fetchPlatformsForStop(stop.id, function(err, platforms) {
                        var platformContainer = document.getElementById('platform-container-' + idx);
                        if (!platformContainer) return;

                        if (!err && platforms.length > 0) {
                            var selectHtml = '<select class="platform-select">' +
                                '<option value="">All platforms</option>';
                            for (var k = 0; k < platforms.length; k++) {
                                var selected = platforms[k] === stop.platform ? ' selected' : '';
                                selectHtml += '<option value="' + escapeAttr(platforms[k]) + '"' + selected + '>Platform ' + escapeHtml(platforms[k]) + '</option>';
                            }
                            selectHtml += '</select>';
                            platformContainer.outerHTML = selectHtml;
                        } else {
                            platformContainer.textContent = 'No platforms found';
                        }
                    });
                })(j, config.stops[j]);
            }
        }

        // Add stop config UI
        function addStopConfig() {
            var container = document.getElementById('stopsConfig');
            var idx = Date.now();
            
            var div = document.createElement('div');
            div.className = 'stop-config';
            div.innerHTML = '<button class="remove-btn" onclick="this.parentElement.parentElement.removeChild(this.parentElement)">×</button>' +
                '<div class="form-group">' +
                '<label>Search for stop</label>' +
                '<input type="text" class="stop-search-input" placeholder="e.g. Düsseldorf Hbf" oninput="handleStopSearch(this, \'results-' + idx + '\')">' +
                '<div class="search-results" id="results-' + idx + '"></div>' +
                '</div>';
            container.appendChild(div);
        }

        // Remove stop config
        function removeStopConfig(idx) {
            config.stops.splice(idx, 1);
            renderStopsConfig();
        }

        // Handle stop search input
        function handleStopSearch(input, resultsId) {
            if (searchTimeouts[resultsId]) clearTimeout(searchTimeouts[resultsId]);
            searchTimeouts[resultsId] = setTimeout(function() {
                searchStops(input.value, resultsId);
            }, 400);
        }

        // Fetch available platforms for a stop
        function fetchPlatformsForStop(stopId, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/departures?stop=' + encodeURIComponent(stopId), true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            var platforms = [];
                            var seen = {};
                            var rawDeps = data.departureList || [];
                            if (!Array.isArray(rawDeps)) {
                                rawDeps = rawDeps ? [rawDeps] : [];
                            }
                            for (var i = 0; i < rawDeps.length; i++) {
                                var platform = rawDeps[i].platform || rawDeps[i].pointName || '';
                                if (platform && !seen[platform]) {
                                    seen[platform] = true;
                                    platforms.push(platform);
                                }
                            }
                            platforms.sort(function(a, b) {
                                var numA = parseInt(a);
                                var numB = parseInt(b);
                                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                                return a.localeCompare(b);
                            });
                            callback(null, platforms);
                        } catch (e) {
                            callback(e, []);
                        }
                    } else {
                        callback(new Error('HTTP ' + xhr.status), []);
                    }
                }
            };
            xhr.send();
        }

        // Render platform selector dropdown
        function renderPlatformSelector(container, platforms, selectedPlatform) {
            var html = '<div class="form-group">' +
                '<label>Platform</label>' +
                '<select class="platform-select">' +
                '<option value="">All platforms</option>';
            for (var i = 0; i < platforms.length; i++) {
                var selected = platforms[i] === selectedPlatform ? ' selected' : '';
                html += '<option value="' + escapeAttr(platforms[i]) + '"' + selected + '>Platform ' + escapeHtml(platforms[i]) + '</option>';
            }
            html += '</select></div>';
            return html;
        }

        // Handle click on search result
        document.addEventListener('click', function(e) {
            var result = e.target;
            while (result && !result.classList.contains('search-result')) {
                result = result.parentElement;
            }
            if (result && result.getAttribute('data-stop-id')) {
                var stopConfig = result;
                while (stopConfig && !stopConfig.classList.contains('stop-config')) {
                    stopConfig = stopConfig.parentElement;
                }
                if (stopConfig) {
                    var stopId = result.getAttribute('data-stop-id');
                    var stopName = result.getAttribute('data-stop-name');
                    stopConfig.setAttribute('data-stop-id', stopId);
                    stopConfig.setAttribute('data-stop-name', stopName);

                    // Show loading state while fetching platforms
                    stopConfig.innerHTML = '<button class="remove-btn" onclick="this.parentElement.parentElement.removeChild(this.parentElement)">×</button>' +
                        '<div class="form-group">' +
                        '<label>Display label</label>' +
                        '<input type="text" class="stop-label-input" value="' + escapeAttr(stopName) + '" placeholder="Custom name">' +
                        '</div>' +
                        '<div class="platform-loading">Loading platforms...</div>' +
                        '<div class="stop-info">Stop: ' + escapeHtml(stopName) + '<br>ID: ' + escapeHtml(stopId) + '</div>';

                    // Fetch platforms and update UI
                    fetchPlatformsForStop(stopId, function(err, platforms) {
                        var platformHtml = '';
                        if (!err && platforms.length > 0) {
                            platformHtml = renderPlatformSelector(stopConfig, platforms, '');
                        } else if (platforms.length === 0) {
                            platformHtml = '<div class="form-group"><label>Platform</label><div class="platform-loading">No platforms found</div></div>';
                        }

                        stopConfig.innerHTML = '<button class="remove-btn" onclick="this.parentElement.parentElement.removeChild(this.parentElement)">×</button>' +
                            '<div class="form-group">' +
                            '<label>Display label</label>' +
                            '<input type="text" class="stop-label-input" value="' + escapeAttr(stopName) + '" placeholder="Custom name">' +
                            '</div>' +
                            platformHtml +
                            '<div class="stop-info">Stop: ' + escapeHtml(stopName) + '<br>ID: ' + escapeHtml(stopId) + '</div>';
                    });
                }
            }
        }, false);

        // Helper: Escape HTML
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        function escapeAttr(str) {
            return escapeHtml(str);
        }

        // Status
        function setStatus(text, state) {
            var el = document.getElementById('status');
            el.textContent = text;
            el.className = 'status ' + (state || '');
        }

        // Modal
        function openModal() {
            renderStopsConfig();
            document.getElementById('modal').className = 'modal open';
        }

        function closeModal() {
            document.getElementById('modal').className = 'modal';
        }

        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === document.getElementById('modal')) closeModal();
        }, false);

        // Refresh timer
        function startRefreshTimer() {
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(fetchAllDepartures, config.refreshInterval * 1000);
        }

        // Initialize
        loadConfig();
        updateClock();
        setInterval(updateClock, 1000);
        renderStopsGrid();
        fetchAllDepartures();
        startRefreshTimer();
    </script>
</body>
</html>
